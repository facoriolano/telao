<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Modo Diretor</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0d0d1a;
      color: white;
      padding: 20px;
    }
    h1 {
      color: #ff7300;
    }
    .slide-atual {
      border: 2px solid #ff7300;
      padding: 15px;
      margin: 20px 0;
      font-size: 18px;
      background: #1c1c2e;
      border-radius: 8px;
      white-space: pre-line;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .card {
      background: #1c1c2e;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      white-space: pre-line;
    }
    .card.active {
      border: 2px solid #ff7300;
      background: #2a2a40;
    }
    button {
      margin: 5px;
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      background: #6c2bd9;
      color: white;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #8839ef;
    }
  </style>
</head>
<body>
  <h1>Modo Diretor</h1>
  <input type="file" id="fileInput" accept=".txt">
  <button onclick="abrirTelao()">Abrir Telão</button>

  <h2>Trecho Atual</h2>
  <div id="trechoAtual" class="slide-atual">Nenhum texto carregado</div>
  <button onclick="voltar()">⬅ Voltar</button>
  <button onclick="avancar()">Avançar ➡</button>

  <h2>Contexto (Todos os Slides)</h2>
  <div class="grid" id="listaSlides"></div>

  <script>
    let todosSlides = [];
    let indiceAtual = 0;
    const channel = new BroadcastChannel("diretor");

    function atualizarTela() {
      if (todosSlides.length === 0) return;
      document.getElementById("trechoAtual").innerText = todosSlides[indiceAtual];
      channel.postMessage(todosSlides[indiceAtual]);
      renderizarMiniaturas();
    }

    function voltar() {
      if (indiceAtual > 0) {
        indiceAtual--;
        atualizarTela();
      }
    }

    function avancar() {
      if (indiceAtual < todosSlides.length - 1) {
        indiceAtual++;
        atualizarTela();
      }
    }

    function renderizarMiniaturas() {
      const lista = document.getElementById("listaSlides");
      lista.innerHTML = "";
      todosSlides.forEach((slide, i) => {
        const div = document.createElement("div");
        div.className = "card" + (i === indiceAtual ? " active" : "");
        div.innerText = slide;
        div.onclick = () => {
          indiceAtual = i;
          atualizarTela();
        };
        lista.appendChild(div);
      });
    }

    document.getElementById("fileInput").addEventListener("change", function () {
      const file = this.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const textoBruto = e.target.result;
        const palavras = textoBruto.split(/\s+/);
        
        const slides = [];
        let bloco = [];
        let linhas = 0;
        let acumulador = "";

        palavras.forEach(palavra => {
          acumulador += palavra + " ";
          if (acumulador.length > 60) { // controla o tamanho de uma linha
            bloco.push(acumulador.trim());
            acumulador = "";
            linhas++;
          }
          if (linhas === 5) {
            slides.push(bloco.join("\n"));
            bloco = [];
            linhas = 0;
          }
        });

        if (acumulador) bloco.push(acumulador.trim());
        if (bloco.length > 0) slides.push(bloco.join("\n"));

        todosSlides = slides;
        indiceAtual = 0;
        atualizarTela();
      };
      reader.readAsText(file);
    });

    function abrirTelao() {
      window.open("telao.html", "_blank");
    }
  </script>
</body>
</html>
