<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Modo Diretor - Telão Interativo</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .miniatura {
      border: 1px solid #ccc;
      padding: 6px;
      margin: 4px;
      cursor: pointer;
      border-radius: 6px;
      background: #f4f4f4;
    }
    .miniatura:hover {
      background-color: #e0e0e0;
    }
    .miniatura.atual {
      background-color: orange;
      font-weight: bold;
      color: white;
    }
    #miniaturas {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
  </style>
</head>
<body>
  <div id="painel">
    <header>
      <h1>Modo Diretor</h1>
      <input type="file" id="fileInput" accept=".txt" />
      <button id="abrirPopUp" disabled>Abrir Telão</button>
    </header>

    <section id="trechoAtualContainer">
      <h2>Trecho Atual</h2>
      <div id="trechoAtual">Carregue o arquivo .txt</div>
      <div class="botoes">
        <button id="voltarBtn">⬅️ Voltar</button>
        <button id="avancarBtn">➡️ Avançar</button>
      </div>
    </section>

    <section id="proximosContainer">
      <h2>Contexto (Anteriores e Próximos)</h2>
      <div id="miniaturas"></div>
    </section>
  </div>

  <script>
    let trechos = [];
    let currentIndex = 0;
    let popupWindow = null;

    const fileInput = document.getElementById("fileInput");
    const abrirPopUpBtn = document.getElementById("abrirPopUp");
    const trechoAtual = document.getElementById("trechoAtual");
    const miniaturas = document.getElementById("miniaturas");
    const avancarBtn = document.getElementById("avancarBtn");
    const voltarBtn = document.getElementById("voltarBtn");

    fileInput.addEventListener("change", function (event) {
      const file = event.target.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        const texto = e.target.result;
        trechos = texto.split("\n").map(l => l.trim()).filter(l => l.length > 0);
        abrirPopUpBtn.disabled = false;
        atualizarTela();
        startReconhecimento();
      };

      reader.readAsText(file);
    });

    abrirPopUpBtn.onclick = () => {
      popupWindow = window.open("", "Telão", "width=800,height=600");
      popupWindow.document.body.style.background = "black";
      popupWindow.document.body.style.color = "white";
      popupWindow.document.body.style.fontSize = "3em";
      popupWindow.document.body.style.display = "flex";
      popupWindow.document.body.style.justifyContent = "center";
      popupWindow.document.body.style.alignItems = "center";
      popupWindow.document.body.style.textAlign = "center";
      popupWindow.document.body.innerHTML = "<p id='texto'></p>";

      atualizarTelao();
    };

    function atualizarTela() {
      trechoAtual.innerText = trechos[currentIndex] || "";
      atualizarTelao();
      atualizarMiniaturas();
    }

    function atualizarTelao() {
      if (popupWindow && !popupWindow.closed) {
        const p = popupWindow.document.getElementById("texto");
        p.innerText = trechos[currentIndex] || "";
      }
    }

    function atualizarMiniaturas() {
      miniaturas.innerHTML = "";
      for (let i = currentIndex - 5; i <= currentIndex + 5; i++) {
        if (i < 0 || i >= trechos.length) continue;
        const div = document.createElement("div");
        div.className = "miniatura";
        if (i === currentIndex) div.classList.add("atual");
        div.innerText = trechos[i];
        div.onclick = () => {
          currentIndex = i;
          atualizarTela();
        };
        miniaturas.appendChild(div);
      }
    }

    function avancar() {
      if (currentIndex < trechos.length - 1) {
        currentIndex++;
        atualizarTela();
      }
    }

    function voltar() {
      if (currentIndex > 0) {
        currentIndex--;
        atualizarTela();
      }
    }

    avancarBtn.onclick = avancar;
    voltarBtn.onclick = voltar;

    document.addEventListener("keydown", (e) => {
      const tecla = e.key.toLowerCase();
      if (tecla === "arrowright" || tecla === "d") avancar();
      if (tecla === "arrowleft" || tecla === "a") voltar();
      if (tecla === "f" && popupWindow && !popupWindow.closed) {
        popupWindow.document.documentElement.requestFullscreen();
      }
    });

    function startReconhecimento() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("Reconhecimento de voz não suportado.");
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = "pt-BR";
      recognition.continuous = true;
      recognition.interimResults = false;

      recognition.onresult = function (event) {
        const falado = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
        console.log("Falado:", falado);

        let encontrado = -1;
        for (let i = Math.max(0, currentIndex - 3); i <= Math.min(trechos.length - 1, currentIndex + 3); i++) {
          if (falado.includes(trechos[i].toLowerCase().slice(0, 10))) {
            encontrado = i;
            break;
          }
        }

        if (encontrado >= 0 && encontrado !== currentIndex) {
          currentIndex = encontrado;
          atualizarTela();
        }

        const trechoAtualTexto = trechos[currentIndex]?.toLowerCase();
        if (trechoAtualTexto && falado.includes(trechoAtualTexto.slice(0, Math.floor(trechoAtualTexto.length * 0.8)))) {
          setTimeout(() => {
            avancar();
          }, 1000);
        }
      };

      recognition.onerror = function (event) {
        console.error("Erro no reconhecimento:", event.error);
      };

      recognition.start();
    }
  </script>
</body>
</html>
