<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Modo Diretor - Telão Interativo</title>
  <style>
    body {
      background-color: #1c1c1c;
      color: white;
      font-family: sans-serif;
    }
    .miniatura {
      border: 1px solid #555;
      padding: 6px;
      margin: 4px;
      cursor: pointer;
      border-radius: 6px;
      background: #2a2a2a;
      color: #f1f1f1;
      max-width: 200px;
      word-wrap: break-word;
      white-space: normal;
    }
    .miniatura:hover {
      background-color: #444;
    }
    .miniatura.atual {
      background-color: orange;
      font-weight: bold;
      color: white;
    }
    #miniaturas {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      /* Removida altura e overflow para mostrar todos os slides */
    }
    .botoes button {
      margin: 0 4px;
      padding: 8px 12px;
    }
    #trechoAtual {
      font-size: 1.4em;
      background: #333;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      white-space: normal;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div id="painel">
    <header>
      <h1>Modo Diretor</h1>
      <input type="file" id="fileInput" accept=".txt" />
      <button id="abrirPopUp" disabled>Abrir Telão</button>
    </header>

    <section id="trechoAtualContainer">
      <h2>Trecho Atual</h2>
      <div id="trechoAtual">Carregue o arquivo .txt</div>
      <div class="botoes">
        <button id="voltarBtn">⬅️ Voltar</button>
        <button id="avancarBtn">➡️ Avançar</button>
      </div>
    </section>

    <section id="proximosContainer">
      <h2>Contexto (Todos os Trechos)</h2>
      <div id="miniaturas"></div>
    </section>
  </div>

  <script>
    let trechos = [];
    let currentIndex = 0;
    let popupWindow = null;
    let avancadoPorVoz = false; // controle para evitar avanços múltiplos seguidos

    const fileInput = document.getElementById("fileInput");
    const abrirPopUpBtn = document.getElementById("abrirPopUp");
    const trechoAtual = document.getElementById("trechoAtual");
    const miniaturas = document.getElementById("miniaturas");
    const avancarBtn = document.getElementById("avancarBtn");
    const voltarBtn = document.getElementById("voltarBtn");

    fileInput.addEventListener("change", function (event) {
      const file = event.target.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        const texto = e.target.result;
        trechos = texto.split("\n").map(l => l.trim()).filter(l => l.length > 0);
        abrirPopUpBtn.disabled = false;
        atualizarTela();
        startReconhecimento();
      };

      reader.readAsText(file);
    });

    abrirPopUpBtn.onclick = () => {
      popupWindow = window.open("", "Telão", "width=800,height=600");
      const doc = popupWindow.document;
      doc.head.innerHTML = `
        <title>Telão</title>
        <style>
          body {
            margin: 0;
            background: black;
            color: white;
            font-size: 2.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            word-break: break-word;
            white-space: normal;
            overflow-wrap: break-word;
            height: 100vh;
            box-sizing: border-box;
            line-height: 1.6em; /* aumenta espaçamento para melhor leitura de 5 linhas */
          }
          #texto {
            max-width: 90vw;
            max-height: 130vh; /* altura maior para caber 5 linhas */
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: normal;
          }
        </style>
      `;
      doc.body.innerHTML = `<p id="texto"></p>`;
      atualizarTelao();
    };

    function atualizarTela() {
      trechoAtual.innerText = trechos[currentIndex] || "";
      atualizarTelao();
      atualizarMiniaturas();
    }

    function atualizarTelao() {
      if (popupWindow && !popupWindow.closed) {
        const p = popupWindow.document.getElementById("texto");
        p.innerText = trechos[currentIndex] || "";
      }
    }

    function atualizarMiniaturas() {
      miniaturas.innerHTML = "";
      for (let i = 0; i < trechos.length; i++) {
        const div = document.createElement("div");
        div.className = "miniatura";
        if (i === currentIndex) div.classList.add("atual");
        div.innerText = trechos[i];
        div.onclick = () => {
          currentIndex = i;
          avancadoPorVoz = false; // resetar controle ao mudar manualmente
          atualizarTela();
        };
        miniaturas.appendChild(div);
      }
    }

    function avancar() {
      if (currentIndex < trechos.length - 1) {
        currentIndex++;
        avancadoPorVoz = false; // resetar controle ao avançar manualmente
        atualizarTela();
      }
    }

    function voltar() {
      if (currentIndex > 0) {
        currentIndex--;
        avancadoPorVoz = false; // resetar controle ao voltar manualmente
        atualizarTela();
      }
    }

    avancarBtn.onclick = avancar;
    voltarBtn.onclick = voltar;

    document.addEventListener("keydown", (e) => {
      const tecla = e.key.toLowerCase();
      if (tecla === "arrowright" || tecla === "d") avancar();
      if (tecla === "arrowleft" || tecla === "a") voltar();
      if (tecla === "f" && popupWindow && !popupWindow.closed) {
        popupWindow.document.documentElement.requestFullscreen();
      }
    });

    function startReconhecimento() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("Reconhecimento de voz não suportado.");
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = "pt-BR";
      recognition.continuous = true;
      recognition.interimResults = false;

      recognition.onresult = function (event) {
        const falado = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
        console.log("Falado:", falado);

        // Buscar correspondência nos 10 trechos antes e depois
        let encontrado = -1;
        const start = Math.max(0, currentIndex - 10);
        const end = Math.min(trechos.length - 1, currentIndex + 10);

        for (let i = start; i <= end; i++) {
          const trechoLower = trechos[i].toLowerCase();
          if (falado.includes(trechoLower.slice(0, 10))) {
            encontrado = i;
            break;
          }
        }

        if (encontrado >= 0 && encontrado !== currentIndex) {
          currentIndex = encontrado;
          avancadoPorVoz = false; // resetar controle ao mudar por voz
          atualizarTela();
          return;
        }

        // Avançar ao detectar a penúltima palavra, evitando múltiplos avanços seguidos
        const trechoAtualTexto = trechos[currentIndex]?.toLowerCase();
        if (trechoAtualTexto && !avancadoPorVoz) {
          const palavras = trechoAtualTexto.split(/\s+/);
          if (palavras.length >= 2) {
            const penultimaPalavra = palavras[palavras.length - 2];
            if (falado.includes(penultimaPalavra)) {
              avancadoPorVoz = true;
              avancar();
            }
          }
        }
      };

      recognition.onerror = function (event) {
        console.error("Erro no reconhecimento:", event.error);
      };

      recognition.start();
    }
  </script>
</body>
</html>
