<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Modo Diretor - Telão Interativo (TAG Slide Único)</title>
  <style>
    body {
      background-color: #1c1c1c;
      color: white;
      font-family: sans-serif;
    }
    .miniatura {
      border: 1px solid #555;
      padding: 6px;
      margin: 4px;
      cursor: pointer;
      border-radius: 6px;
      background: #2a2a2a;
      color: #f1f1f1;
      max-width: 300px;
      min-width: 220px;
      word-wrap: break-word;
      white-space: pre-line;
      font-size: 1em;
      display: block;
    }
    .miniatura:hover {
      background-color: #444;
    }
    .miniatura.atual {
      background-color: orange;
      font-weight: bold;
      color: white;
    }
    #miniaturas {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .botoes button {
      margin: 0 4px;
      padding: 8px 12px;
    }
    #trechoAtual {
      font-size: 1.4em;
      background: #333;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      white-space: pre-line;
      word-break: break-word;
      min-height: 7.5em;
      line-height: 1.5em;
    }
  </style>
</head>
<body>
  <div id="painel">
    <header>
      <h1>Modo Diretor - Telão Interativo</h1>
      <input type="file" id="fileInput" accept=".txt" />
      <button id="abrirPopUp" disabled>Abrir Telão</button>
    </header>

    <section id="trechoAtualContainer">
      <h2>Trecho Atual</h2>
      <div id="trechoAtual">Carregue o arquivo .txt</div>
      <div class="botoes">
        <button id="voltarBtn">⬅️ Voltar</button>
        <button id="avancarBtn">➡️ Avançar</button>
      </div>
    </section>

    <section id="proximosContainer">
      <h2>Contexto (Todos os Slides)</h2>
      <div id="miniaturas"></div>
    </section>
  </div>

  <script>
    let slides = [];
    let currentSlideIndex = 0;
    let popupWindow = null;
    let avancadoPorVoz = false;
    const groupSize = 5;

    const fileInput = document.getElementById("fileInput");
    const abrirPopUpBtn = document.getElementById("abrirPopUp");
    const trechoAtual = document.getElementById("trechoAtual");
    const miniaturas = document.getElementById("miniaturas");
    const avancarBtn = document.getElementById("avancarBtn");
    const voltarBtn = document.getElementById("voltarBtn");

    fileInput.addEventListener("change", function (event) {
      const file = event.target.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        const texto = e.target.result;
        slides = processarSlides(texto);
        currentSlideIndex = 0;
        avancadoPorVoz = false;
        abrirPopUpBtn.disabled = false;
        atualizarTela();
        startReconhecimento();
      };

      reader.readAsText(file);
    });

    // Função para processar o arquivo e criar slides conforme a regra das TAGs
    function processarSlides(texto) {
      const linhas = texto.split("\n").map(l => l.trim()).filter(l => l.length > 0);
      const slides = [];
      let buffer = [];

      linhas.forEach(linha => {
        if (/^\[.+?\]/.test(linha)) {
          // Se houver linhas acumuladas, cria um slide com elas
          if (buffer.length > 0) {
            slides.push(buffer.join('\n'));
            buffer = [];
          }
          // Slide único para a linha com TAG (remove os colchetes)
          slides.push(linha.replace(/^\[(.+?)\]\s*/, '').trim());
        } else {
          buffer.push(linha);
          if (buffer.length === groupSize) {
            slides.push(buffer.join('\n'));
            buffer = [];
          }
        }
      });
      // Adiciona o restante do buffer como último slide, se houver
      if (buffer.length > 0) {
        slides.push(buffer.join('\n'));
      }
      return slides;
    }

    abrirPopUpBtn.onclick = () => {
      popupWindow = window.open("", "Telão", "width=800,height=600");
      const doc = popupWindow.document;
      doc.head.innerHTML = `
        <title>Telão</title>
        <style>
          body {
            margin: 0;
            background: black;
            color: white;
            font-size: 2.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            word-break: break-word;
            white-space: pre-line;
            overflow-wrap: break-word;
            height: 100vh;
            box-sizing: border-box;
            line-height: 1.5em;
          }
          #texto {
            max-width: 90vw;
            max-height: 90vh;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: pre-line;
          }
        </style>
      `;
      doc.body.innerHTML = `<p id="texto"></p>`;
      atualizarTelao();
    };

    function atualizarTela() {
      trechoAtual.innerText = slides[currentSlideIndex] || "";
      atualizarTelao();
      atualizarMiniaturas();
    }

    function atualizarTelao() {
      if (popupWindow && !popupWindow.closed) {
        const p = popupWindow.document.getElementById("texto");
        p.innerText = slides[currentSlideIndex] || "";
      }
    }

    function atualizarMiniaturas() {
      miniaturas.innerHTML = "";
      let atualDiv = null;
      for (let i = 0; i < slides.length; i++) {
        const div = document.createElement("div");
        div.className = "miniatura";
        if (i === currentSlideIndex) {
          div.classList.add("atual");
          atualDiv = div;
        }
        div.innerText = slides[i];
        div.title = slides[i];
        div.onclick = () => {
          currentSlideIndex = i;
          avancadoPorVoz = false;
          atualizarTela();
        };
        miniaturas.appendChild(div);
      }
      if (atualDiv && !isElementInViewport(atualDiv)) {
        atualDiv.scrollIntoView({block: "nearest", behavior: "smooth"});
      }
    }

    function isElementInViewport(el) {
      const rect = el.getBoundingClientRect();
      return (
        rect.top >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight)
      );
    }

    function avancar() {
      if (currentSlideIndex < slides.length - 1) {
        currentSlideIndex++;
        avancadoPorVoz = false;
        atualizarTela();
      }
    }

    function voltar() {
      if (currentSlideIndex > 0) {
        currentSlideIndex--;
        avancadoPorVoz = false;
        atualizarTela();
      }
    }

    avancarBtn.onclick = avancar;
    voltarBtn.onclick = voltar;

    document.addEventListener("keydown", (e) => {
      const tecla = e.key.toLowerCase();
      if (tecla === "arrowright" || tecla === "d") avancar();
      if (tecla === "arrowleft" || tecla === "a") voltar();
      if (tecla === "f" && popupWindow && !popupWindow.closed) {
        popupWindow.document.documentElement.requestFullscreen();
      }
    });

    function startReconhecimento() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("Reconhecimento de voz não suportado.");
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = "pt-BR";
      recognition.continuous = true;
      recognition.interimResults = false;

      recognition.onresult = function (event) {
        const falado = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
        let encontrado = -1;
        const startSlide = Math.max(0, currentSlideIndex - 10);
        const endSlide = Math.min(slides.length - 1, currentSlideIndex + 10);

        for (let i = startSlide; i <= endSlide; i++) {
          const slideTexto = slides[i].toLowerCase();
          if (falado.includes(slideTexto.slice(0, 15))) {
            encontrado = i;
            break;
          }
        }

        if (encontrado >= 0 && encontrado !== currentSlideIndex) {
          currentSlideIndex = encontrado;
          avancadoPorVoz = false;
          atualizarTela();
          return;
        }

        // Avançar se pelo menos 70% do texto do slide foi reconhecido
        if (!avancadoPorVoz) {
          const textoSlide = slides[currentSlideIndex].toLowerCase().replace(/[^\w\s]/gi, '');
          const faladoLimpo = falado.replace(/[^\w\s]/gi, '');
          const palavrasTexto = textoSlide.split(/\s+/).filter(Boolean);
          const palavrasFaladas = faladoLimpo.split(/\s+/).filter(Boolean);

          let acertos = 0;
          palavrasTexto.forEach(palavra => {
            if (palavrasFaladas.includes(palavra)) acertos++;
          });

          const percentual = acertos / palavrasTexto.length;
          if (percentual >= 0.7) {
            avancadoPorVoz = true;
            avancar();
          }
        }
      };

      recognition.onerror = function (event) {
        console.error("Erro no reconhecimento:", event.error);
      };

      recognition.start();
    }
  </script>
</body>
</html>
